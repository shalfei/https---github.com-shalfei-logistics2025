# Решение E-CUP 2025: ML Challenge, трек Логистика


## Описание задачи
Требуется разработать воспроизводимый алгоритм решения VRP‑задачи, который cтроит маршруты для 200+ курьеров так, чтобы:
- Каждый курьер обслуживал заказы с учетом персонального времени обслуживания разных типов точек (MpId);
- Суммарное время работы алгоритма укладывалось в ограничения (60 минут);
- Время работы каждого курьера было не более 12 часов.
  
## Бизнес требования

- Маршрут курьера начинается и заканчивается на складе (Warehouse ID=0);
- Время работы курьера ограничено 12 часами (8:00-20:00);
- Каждый курьер может обслуживать разные типы точек с персональным временем обслуживания.
- Заказы разделены на микрополигоны. Каждый микрополигон может обслуживать только один курьер (нельзя дробить).

## Структура файлов
***!!! Файлы не представлены в репозитории по причине большого размера !!!***

В папке должны лежать файлы:
- `ml_ozon_logistic_dataDurations.json` - база данных расстояний между точками
- `ml_ozon_logistic_dataSetCouriers.json` - данные о курьерах и их сервисных временах
- `ml_ozon_logistic_dataSetOrders.json` - данные о заказах и их локациях

### Содержимое:

`dataSetOrders.json` (~1,2 MB) — 20 160 заказов с координатами и типами точек.<br>
Структура: <br>
<i>{"Orders": [{"ID": int, "Lat": float, "Long": float, "MpId": int}]}</i>

`dataSetCouriers.json` (~20 MB) — 240 курьеров с персональными сервис-таймами по MpId; склад (Warehouse ID=1); рабочее окно 8:00–20:00.<br>
Структура: <br>
<i>{"CourierTimeWork": {"TSStart": 28800, "TSEnd": 72000}, "Warehouse": {"ID": 1, "Lat": float, "Long": float, "MpId": 0, "ServiceTime": 300}, "Couriers": [{"ID": int, "ServiceTimeInMps": [{"MpID": int, "ServiceTime": int}]}]}</i>

`dataDurations.json` (~14 GB) — порядка 400 млн записей с длительностями/дистанциями между всеми парами точек (склад↔заказы, заказы↔заказы).<br>
Структура: <br>
<i>[{"from": int, "to": int, "dist": int}] </i>



## Описание алгоритма (rtr_and_ortools.py)

### Запуск
```bash
python rtr_and_ortools.py --orders ml_ozon_logistic_dataSetOrders.json --couriers ml_ozon_logistic_dataSetCouriers.json --durations_json ml_ozon_logistic_dataDurations.json --durations_db durations.sqlite --output solution.json
```

1. **Загрузка данных**
   - Загружает заказы и курьеров из JSON файлов
   - Использует только первые 280 курьеров из доступных
   - Конвертирует JSON с расстояниями в SQLite для быстрого доступа
   - Создает индексы для оптимизации запросов

2. **Алгоритм маршрутизации**
      - Расчитывается матрица расстояний от заказов до склада
      - **Внутренняя оптимизация**: Внутри каждого полигона используется алгоритм ближайшего соседа (Nearest Neighbor)
      - **Назначение курьерам**: Полигоны назначаются курьерам жадным алгоритмом с учетом ограничений:
        - Максимальное время работы: 12 часов (43200 секунд)
        - Штраф за неразмещенные заказы: 3000 секунд

4. **Оптимизация маршрутов**
   - Вычисляет время маршрута с учетом:
     - Расстояний между точками
     - Сервисного времени курьера в каждой точке
     - Возврата на склад
   - Использует fallback через склад для отсутствующих прямых связей

5. **Выходные данные**
   - Создает файл `solution.json` с маршрутами для каждого курьера
   - Формат: `{"routes": [{"courier_id": X, "route": [0, order1, order2, ..., 0]}]}`

## Проверка решения (scoring.py)

### Запуск
```bash
python scoring.py --orders ml_ozon_logistic_dataSetOrders.json --couriers ml_ozon_logistic_dataSetCouriers.json --durations_db durations.sqlite --submission solution.json
```

### Что делает scoring.py

1. **Валидация решения**
   - Проверяет корректность формата submission.json
   - Валидирует ID курьеров и заказов
   - Проверяет уникальность заказов между маршрутами
   - Убеждается, что заказы из одного микро-полигона не разделены между курьерами

2. **Вычисление расстояний**
   - Ищет прямые связи между точками
   - При отсутствии прямых связей ищет обратные
   - В крайнем случае использует маршрут через склад (ID=0)

3. **Расчет финального скора**
   - Суммирует время всех маршрутов
   - Добавляет штраф за неразмещенные закады (3000 сек за заказ)
   - Проверяет ограничение 12 часов на маршрут

4. **Выходные данные**
   - Выводит статистику по типам связей (прямые, обратные, через склад)
   - Количество неразмещенных заказов
   - Финальный скор в секундах

## Алгоритмические особенности

- **Жадная стратегия**: Полигоны назначаются курьерам по принципу "первый подходящий"
- **Fallback маршрутизация**: При отсутствии прямых связей используется маршрут через склад
- **Оптимизация памяти**: Потоковая обработка больших файлов, LRU кэширование
- **Балансировка нагрузки**: Учет текущего времени работы курьера при назначении новых полигонов

\
